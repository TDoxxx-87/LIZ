<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Fusion ‚Äì Mobile Overlay-Vergleich + DGM (transparent)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --sheet-max: 920px;
      --pad: 12px;
      --radius: 14px;
      --shadow: 0 8px 24px rgba(0,0,0,.18);
      --safe-b: env(safe-area-inset-bottom, 0px);
    }
    html, body, #map { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* Map z-index below UI */
    #map { z-index: 0; }

    /* Floating Action Button (√∂ffnet/schlie√üt das Sheet auf Mobile) */
    .fab {
      position: fixed; right: 14px; bottom: calc(16px + var(--safe-b));
      z-index: 1100;
      width: 48px; height: 48px; border-radius: 24px;
      background: #111; color: #fff; display: grid; place-items: center;
      box-shadow: 0 6px 16px rgba(0,0,0,.25); border: none; cursor: pointer;
      font-size: 20px;
    }

    /* Bottom-Sheet mit allen Controls */
    .sheet {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 0; width: min(96vw, var(--sheet-max));
      background: rgba(255,255,255,.96); backdrop-filter: blur(6px);
      border-radius: var(--radius) var(--radius) 0 0;
      box-shadow: var(--shadow); z-index: 1050;
      transition: translate .2s ease, height .2s ease;
      /* Start: mobile eingeklappt */
      translate: 0 calc(100% - 44px - var(--safe-b));
      will-change: translate;
    }
    .sheet.open { translate: 0 0; }

    .sheet__grab {
      display: grid; place-items: center;
      padding: 6px 0 8px;
      cursor: pointer;
    }
    .sheet__bar {
      width: 38px; height: 5px; border-radius: 999px; background: #cfd3d9;
    }

    .sheet__inner {
      padding: 0 var(--pad) calc(var(--pad) + var(--safe-b));
    }

    /* Controls-Layout */
    .grid {
      display: grid; gap: 10px;
      grid-template-columns: 1fr; /* Mobile: 1 Spalte */
    }
    .card {
      border: 1px solid #e7e9ee; border-radius: 12px; padding: 10px;
      background: #fff;
    }
    .card h3 {
      margin: 0 0 8px 0; font-size: 14px;
    }
    .row { display: grid; grid-template-columns: auto 1fr auto; gap: 8px; align-items: center; }
    .row label { font-size: 12px; white-space: nowrap; }
    .row input[type="range"] { width: 100%; }

    .field {
      display: grid; gap: 6px;
    }
    .field label { font-size: 12px; }
    select, input[type="range"] {
      font-size: 16px; /* gr√∂√üere Touch-Ziele */
      padding: 10px; border: 1px solid #dcdfe5; border-radius: 10px; background: #fff; outline: none;
    }

    .toggle {
      display: inline-flex; align-items: center; gap: 8px; font-size: 14px; user-select: none;
    }
    .toggle input { width: 18px; height: 18px; }

    /* Desktop breiter: 2 Spalten */
    @media (min-width: 820px) {
      .sheet { translate: 0 0; }           /* Desktop: offen */
      .fab { display: none; }              /* FAB nur Mobile */
      .grid { grid-template-columns: 1fr 1fr; }
    }
  </style>

  <!-- qgis2web-GeoJSON: Dateiname ggf. anpassen -->
  <script src="data/BRB_denkmalbb_bodendenkmalflchen_1.js"></script>
</head>
<body>
  <div id="map"></div>

  <!-- FAB (nur Mobile sichtbar) -->
  <button class="fab" id="fabBtn" aria-label="Layer & DGM √∂ffnen">üõ†Ô∏è</button>

  <!-- Bottom Sheet: DGM + Feature-Toggle + A/B + Opacity -->
  <div class="sheet" id="sheet">
    <div class="sheet__grab" id="sheetGrab" title="Tippen zum Auf-/Zuklappen">
      <div class="sheet__bar"></div>
    </div>
    <div class="sheet__inner">
      <div class="grid">
        <div class="card">
          <h3>DGM (normal) ‚Äì Transparenz</h3>
          <div class="row">
            <label for="dgmRange">Deckkraft</label>
            <input id="dgmRange" type="range" min="0" max="1" step="0.01" value="0.0">
            <span id="dgmVal" style="font-size:12px;">0%</span>
          </div>
          <label class="toggle" style="margin-top:8px;">
            <input type="checkbox" id="chkFeat" checked>
            <span>Bodendenkmale (GeoJSON) anzeigen</span>
          </label>
        </div>

        <div class="card">
          <h3>Overlay-Vergleich</h3>
          <div class="field">
            <label for="selA">Overlay A (Referenz, 100%)</label>
            <select id="selA"></select>
          </div>
          <div class="field">
            <label for="selB">Overlay B (Deckkraft unten)</label>
            <select id="selB"></select>
          </div>
          <div class="field" style="margin-top:6px;">
            <label for="globalOpacity">Deckkraft Overlay B</label>
            <input id="globalOpacity" type="range" min="0" max="1" step="0.01" value="0.6" />
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== WMS-Dienste ===== */
const wmsServices = [
  { n: "bDOM 2020-2022",                   u: "https://isk.geobasis-bb.de/mapproxy/bdom20202022/service/wms?" },
  { n: "Preu√üen_1877",                     u: "https://isk.geobasis-bb.de/mapproxy/dr25/service/wms?" },
  { n: "bDOM 2017-2019",                   u: "https://isk.geobasis-bb.de/mapproxy/bdom20172019/service/wms?" },
  { n: "DGM (aktuell)",                    u: "https://isk.geobasis-bb.de/mapproxy/dgm/service/wms?" },   // DGM
  { n: "DOP20 rgbi 2019-2021",             u: "https://isk.geobasis-bb.de/mapproxy/dop20_2019_2021/service/wms?" },
  { n: "DOP20 rgbi 2016-2018",             u: "https://isk.geobasis-bb.de/mapproxy/dop20_2016_2018/service/wms?" },
  { n: "DOP20 rgbi 2013-2015",             u: "https://isk.geobasis-bb.de/mapproxy/dop20_2013_2015/service/wms?" },
  { n: "DOP20 rgbi 2009-2012",             u: "https://isk.geobasis-bb.de/mapproxy/dop20_2009_2012/service/wms?" },
  { n: "DOP20 c 2005-2010",                u: "https://isk.geobasis-bb.de/mapproxy/dop20_2005_2010/service/wms?" },
  { n: "DOP40 g 2001-2009",                u: "https://isk.geobasis-bb.de/mapproxy/dop40g_2001_2009/service/wms?" },
  { n: "DOP50 g 1992-1997",                u: "https://isk.geobasis-bb.de/mapproxy/dop50g_1992_1997/service/wms?" },
  { n: "DOP100 g 2001-2005",               u: "https://isk.geobasis-bb.de/mapproxy/dop100g_2001_2005/service/wms?" },
  { n: "DOP100 g 1953",                    u: "https://isk.geobasis-bb.de/mapproxy/dop100g_1953/service/wms?" },
  { n: "DTK10 1986-2000",                  u: "https://isk.geobasis-bb.de/mapproxy/dtk10farbe/service/wms?" },
  { n: "DTK25 1989-1999",                  u: "https://isk.geobasis-bb.de/mapproxy/dtk25farbe/service/wms?" },
  { n: "DTSK25 1990-2001",                 u: "https://isk.geobasis-bb.de/mapproxy/dtsk25_1990_2001/service/wms?" },
  { n: "DTK50 1993-2005",                  u: "https://isk.geobasis-bb.de/mapproxy/dtk50farbe/service/wms?" },
  { n: "DTK100 1987-2004",                 u: "https://isk.geobasis-bb.de/mapproxy/dtk100farbe/service/wms?" },
  { n: "Schmettausches Kartenwerk 1767-1787", u: "https://isk.geobasis-bb.de/mapproxy/schmettau/service/wms?" }
];

/* ===== Karte ===== */
const map = L.map('map', { zoomControl:true }).setView([52.5,13.3], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'¬© OpenStreetMap-Mitwirkende'}).addTo(map);

/* Panes */
map.createPane('overlayA');
map.createPane('overlayB');
map.createPane('dgmPane');

/* UI-Refs */
const selA = document.getElementById('selA');
const selB = document.getElementById('selB');
const globalOpacity = document.getElementById('globalOpacity');
const dgmRange = document.getElementById('dgmRange');
const dgmVal = document.getElementById('dgmVal');
const chkFeat = document.getElementById('chkFeat');

/* Sheet/FAB */
const sheet = document.getElementById('sheet');
const fabBtn = document.getElementById('fabBtn');
const sheetGrab = document.getElementById('sheetGrab');
const toggleSheet = () => sheet.classList.toggle('open');
fabBtn.addEventListener('click', toggleSheet);
sheetGrab.addEventListener('click', toggleSheet);

/* Container */
const layers = Object.create(null);
let dgmLayer = null;
let featLayer = null;

/* ===== Feature-Layer (GeoJSON aus qgis2web) ===== */
function styleFeat() { return { color:'rgba(255,195,0,1.0)', weight:1, opacity:1, fillOpacity:0 }; }
function popFeat(feature, layer) {
  const p = feature && feature.properties || {};
  let html = '<table>';
  for (const k in p) { if (!Object.prototype.hasOwnProperty.call(p,k)) continue; html += `<tr><td><b>${k}</b></td><td>${p[k]}</td></tr>`; }
  html += '</table>';
  layer.bindPopup(html, {maxHeight:400});
}

// Variable kommt aus data/BRB_denkmalbb_bodendenkmalflchen_1.js
try {
  if (typeof json_BRB_denkmalbb_bodendenkmalflchen_1 !== 'undefined') {
    featLayer = L.geoJSON(json_BRB_denkmalbb_bodendenkmalflchen_1, { style: styleFeat, onEachFeature: popFeat, pane:'overlayA' }).addTo(map);
    layers['Bodendenkmale (BRB)'] = { tile: featLayer };
    try { map.fitBounds(featLayer.getBounds(), { padding:[20,20] }); } catch(e) {}
  } else {
    console.warn('GeoJSON-Variable nicht gefunden ‚Äì pr√ºfe data/-Pfad.');
  }
} catch (e) { console.warn('Feature-Layer Fehler:', e); }

/* Checkbox Feature-Layer */
chkFeat.addEventListener('change', () => {
  if (!featLayer) return;
  if (chkFeat.checked) featLayer.addTo(map); else map.removeLayer(featLayer);
});

/* ===== WMS Utility ===== */
async function fetchFirstLayerName(baseUrl) {
  try {
    const url = `${baseUrl}${baseUrl.includes('?') ? '' : '?'}service=WMS&request=GetCapabilities&version=1.3.0`;
    const xml = await (await fetch(url)).text();
    const doc = new DOMParser().parseFromString(xml, 'text/xml');
    const node = doc.querySelector('Layer > Name');
    return node ? node.textContent.trim() : null;
  } catch(e) { console.warn('GetCapabilities fehlgeschlagen:', baseUrl, e); return null; }
}

/* ===== Dropdowns ===== */
function addOption(select, name) {
  const opt = document.createElement('option'); opt.value = name; opt.textContent = name;
  select.appendChild(opt);
}
function fillSelects(names) {
  function setup(select) {
    select.innerHTML = '';
    const none = document.createElement('option'); none.value='__none__'; none.textContent='‚Äî kein ‚Äî'; select.appendChild(none);
    names.forEach(n => { if(n!=='DGM (aktuell)') addOption(select, n); });
  }
  setup(selA); setup(selB);
}

/* ===== Sichtbarkeit & Opazit√§ten ===== */
function updateOverlayVisibility() {
  const a = selA.value, b = selB.value;
  Object.values(layers).forEach(o => o.tile && o.tile.setOpacity && o.tile.setOpacity(0));
  if (a && a!=='__none__' && layers[a] && layers[a].tile.setOpacity) layers[a].tile.setOpacity(1);
  if (b && b!=='__none__' && layers[b] && layers[b].tile.setOpacity) layers[b].tile.setOpacity(parseFloat(globalOpacity.value));
}

/* ===== DGM Deckkraft ===== */
function applyDgmOpacity() {
  const t = parseFloat(dgmRange.value);
  dgmVal.textContent = Math.round(t*100) + '%';
  if (dgmLayer && dgmLayer.setOpacity) dgmLayer.setOpacity(t);
}

/* ===== Init: WMS laden ===== */
(async () => {
  const names = Object.keys(layers); // evtl. schon 'Bodendenkmale (BRB)'
  for (const svc of wmsServices) {
    const lname = await fetchFirstLayerName(svc.u);
    if (!lname) continue;

    if (svc.n === 'DGM (aktuell)') {
      dgmLayer = L.tileLayer.wms(svc.u, { layers: lname, format:'image/png', transparent:true, opacity:0.0, pane:'dgmPane' }).addTo(map);
      names.push(svc.n);
      continue;
    }
    const tile = L.tileLayer.wms(svc.u, { layers: lname, format:'image/png', transparent:true, opacity:0, pane:'overlayA' }).addTo(map);
    layers[svc.n] = { tile };
    names.push(svc.n);
  }

  fillSelects(names.length ? names : ['Bodendenkmale (BRB)']);

  // Defaults
  if ([...selA.options].some(o => o.value==='Bodendenkmale (BRB)')) selA.value = 'Bodendenkmale (BRB)';
  const defB = 'bDOM 2020-2022';
  if ([...selB.options].some(o => o.value===defB)) selB.value = defB;

  updateOverlayVisibility();
  applyDgmOpacity();
})();
  
/* ===== Kleine UX-Optimierungen auf Mobile ===== */
(function tuneMobile(){
  const isNarrow = window.matchMedia('(max-width: 820px)').matches;
  if (isNarrow) {
    // Sheet auf Mobile standardm√§√üig zu (Klasse entfernt = zu) ‚Äì ist bereits per CSS so
    // Wenn der Nutzer interagiert, Sheet automatisch √∂ffnen:
    [selA, selB, globalOpacity, dgmRange, chkFeat].forEach(el=>{
      el && el.addEventListener('focus', ()=> sheet.classList.add('open'), {once:true});
    });
  } else {
    // Desktop: offen lassen
    sheet.classList.add('open');
  }
})();
</script>
</body>
</html>
