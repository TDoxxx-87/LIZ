<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Fusion ‚Äì Mobile, CORS-frei, feste Layernamen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --sheet-max: 920px;
      --pad: 12px;
      --radius: 14px;
      --shadow: 0 8px 24px rgba(0,0,0,.18);
      --safe-b: env(safe-area-inset-bottom, 0px);
    }
    html, body, #map { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* FAB */
    .fab {
      position: fixed; right: 14px; bottom: calc(16px + var(--safe-b));
      z-index: 1100; width: 48px; height: 48px; border-radius: 24px;
      background: #111; color:#fff; display:grid; place-items:center;
      box-shadow: 0 6px 16px rgba(0,0,0,.25); border:none; cursor:pointer; font-size:20px;
    }

    /* Bottom-Sheet */
    .sheet {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 0; width: min(96vw, var(--sheet-max));
      background: rgba(255,255,255,.96); backdrop-filter: blur(6px);
      border-radius: var(--radius) var(--radius) 0 0; box-shadow: var(--shadow); z-index: 1050;
      translate: 0 calc(100% - 44px - var(--safe-b)); transition: translate .2s ease;
    }
    .sheet.open { translate: 0 0; }
    .sheet__grab { display:grid; place-items:center; padding:6px 0 8px; cursor:pointer; }
    .sheet__bar  { width:38px; height:5px; border-radius:999px; background:#cfd3d9; }
    .sheet__inner{ padding: 0 var(--pad) calc(var(--pad) + var(--safe-b)); }

    /* Controls */
    .grid { display:grid; gap:10px; grid-template-columns:1fr; }
    .card { border:1px solid #e7e9ee; border-radius:12px; padding:10px; background:#fff; }
    .card h3 { margin:0 0 8px 0; font-size:14px; }
    .row { display:grid; grid-template-columns:auto 1fr auto; gap:8px; align-items:center; }
    .row label { font-size:12px; white-space:nowrap; }
    .row input[type="range"] { width:100%; }
    .field { display:grid; gap:6px; }
    .field label { font-size:12px; }
    select, input[type="range"] { font-size:16px; padding:10px; border:1px solid #dcdfe5; border-radius:10px; background:#fff; outline:none; }
    .toggle { display:inline-flex; align-items:center; gap:8px; font-size:14px; user-select:none; }
    .toggle input { width:18px; height:18px; }

    /* Desktop: offen, 2 Spalten, FAB aus */
    @media (min-width: 820px) {
      .sheet { translate: 0 0; }
      .fab { display:none; }
      .grid { grid-template-columns: 1fr 1fr; }
    }
  </style>

  <!-- qgis2web-GeoJSON: Dateiname ggf. anpassen -->
  <script src="data/BRB_denkmalbb_bodendenkmalflchen_1.js"></script>
</head>
<body>
  <div id="map"></div>

  <!-- FAB (Mobile) -->
  <button class="fab" id="fabBtn" aria-label="Layer & DGM √∂ffnen">üõ†Ô∏è</button>

  <!-- Bottom Sheet -->
  <div class="sheet" id="sheet">
    <div class="sheet__grab" id="sheetGrab" title="Tippen zum Auf-/Zuklappen">
      <div class="sheet__bar"></div>
    </div>
    <div class="sheet__inner">
      <div class="grid">
        <div class="card">
          <h3>DGM (normal) ‚Äì Transparenz</h3>
          <div class="row">
            <label for="dgmRange">Deckkraft</label>
            <input id="dgmRange" type="range" min="0" max="1" step="0.01" value="0.4">
            <span id="dgmVal" style="font-size:12px;">40%</span>
          </div>
          <label class="toggle" style="margin-top:8px;">
            <input type="checkbox" id="chkFeat" checked>
            <span>Bodendenkmale (GeoJSON) anzeigen</span>
          </label>
        </div>

        <div class="card">
          <h3>Overlay-Vergleich</h3>
          <div class="field">
            <label for="selA">Overlay A (Referenz, 100%)</label>
            <select id="selA"></select>
          </div>
          <div class="field">
            <label for="selB">Overlay B (Deckkraft unten)</label>
            <select id="selB"></select>
          </div>
          <div class="field" style="margin-top:6px;">
            <label for="globalOpacity">Deckkraft Overlay B</label>
            <input id="globalOpacity" type="range" min="0" max="1" step="0.01" value="0.6" />
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========= WMS-Dienste (CORS-frei, feste Layernamen) =========
   Quelle der Namen, u. a.:
   - dop20_bebb_2019_2021_farbe / _graustufen (DOP20 2019‚Äì2021) ‚Äì offizielle Dienstseite
   - dop20_bebb_2016_2018_farbe / _graustufen (DOP20 2016‚Äì2018) ‚Äì offizielle Dienstseite
   - dr25 (Messtischblatt) ‚Äì offizielle Dienstseite
   - dgm (Digitales Gel√§ndemodell)
*/
const WMS = [
  { n: "2019‚Äì2021 (Farbe)", u: "https://isk.geobasis-bb.de/mapproxy/dop20_2019_2021/service/wms?", layer: "dop20_bebb_2019_2021_farbe" },
  { n: "2013‚Äì2015",  u: "https://isk.geobasis-bb.de/mapproxy/dop20_2013_2015/service/wms?", layer: "dop20_bebb_2013_2015_farbe" },
  { n: "2016‚Äì2018 (Farbe)", u: "https://isk.geobasis-bb.de/mapproxy/dop20_2016_2018/service/wms?", layer: "dop20_bebb_2016_2018_farbe" },
  { n: "DOP20 2016‚Äì2018 (Grau)",  u: "https://isk.geobasis-bb.de/mapproxy/dop20_2016_2018/service/wms?", layer: "dop20_bebb_2016_2018_graustufen" },
  { n: "DR25 (Messtischblatt)",   u: "https://isk.geobasis-bb.de/mapproxy/dr25/service/wms?",              layer: "dr25" },
  { n: "DGM (aktuell)",           u: "https://isk.geobasis-bb.de/mapproxy/dgm/service/wms?",               layer: "dgm", isDGM: true }
];

/* ========= Karte ========= */
const map = L.map('map', { zoomControl:true }).setView([52.5,13.3], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'¬© OpenStreetMap-Mitwirkende'}).addTo(map);

/* Panes */
map.createPane('overlayA'); map.getPane('overlayA').style.zIndex = 350;
map.createPane('overlayB'); map.getPane('overlayB').style.zIndex = 360;
map.createPane('dgmPane');  map.getPane('dgmPane').style.zIndex  = 500;

/* UI-Refs */
const selA = document.getElementById('selA');
const selB = document.getElementById('selB');
const globalOpacity = document.getElementById('globalOpacity');
const dgmRange = document.getElementById('dgmRange');
const dgmVal = document.getElementById('dgmVal');
const chkFeat = document.getElementById('chkFeat');

/* Sheet/FAB */
const sheet = document.getElementById('sheet');
const fabBtn = document.getElementById('fabBtn');
const sheetGrab = document.getElementById('sheetGrab');
const toggleSheet = () => sheet.classList.toggle('open');
fabBtn.addEventListener('click', toggleSheet);
sheetGrab.addEventListener('click', toggleSheet);

/* Container */
const layers = Object.create(null);
let dgmLayer = null;
let featLayer = null;

/* ===== Feature-Layer (GeoJSON aus qgis2web) ===== */
function styleFeat() { return { color:'rgba(255,195,0,1.0)', weight:1, opacity:1, fillOpacity:0 }; }
function popFeat(feature, layer) {
  const p = feature && feature.properties || {};
  let html = '<table>';
  for (const k in p) { if (!Object.prototype.hasOwnProperty.call(p,k)) continue; html += `<tr><td><b>${k}</b></td><td>${p[k]}</td></tr>`; }
  html += '</table>';
  layer.bindPopup(html, {maxHeight:400});
}
try {
  if (typeof json_BRB_denkmalbb_bodendenkmalflchen_1 !== 'undefined') {
    featLayer = L.geoJSON(json_BRB_denkmalbb_bodendenkmalflchen_1, { style: styleFeat, onEachFeature: popFeat, pane:'overlayA' }).addTo(map);
    layers['Bodendenkmale (BRB)'] = { tile: featLayer };
    try { map.fitBounds(featLayer.getBounds(), { padding:[20,20] }); } catch(e) {}
  } else {
    console.warn('GeoJSON-Variable nicht gefunden ‚Äì pr√ºfe data/-Pfad.');
  }
} catch (e) { console.warn('Feature-Layer Fehler:', e); }

/* ===== Dropdowns ===== */
function addOption(select, name) {
  const opt = document.createElement('option'); opt.value = name; opt.textContent = name;
  select.appendChild(opt);
}
function fillSelects(names) {
  function setup(select) {
    select.innerHTML = '';
    const none = document.createElement('option'); none.value='__none__'; none.textContent='‚Äî kein ‚Äî'; select.appendChild(none);
    names.forEach(n => { if(n!=='DGM (aktuell)') addOption(select, n); });
  }
  setup(selA); setup(selB);
}

/* ===== Sichtbarkeit & Opazit√§ten ===== */
function updateOverlayVisibility() {
  const a = selA.value, b = selB.value;
  Object.values(layers).forEach(o => o.tile && o.tile.setOpacity && o.tile.setOpacity(0));
  if (a && a!=='__none__' && layers[a] && layers[a].tile.setOpacity) layers[a].tile.setOpacity(1);
  if (b && b!=='__none__' && layers[b] && layers[b].tile.setOpacity) layers[b].tile.setOpacity(parseFloat(globalOpacity.value));
}

/* ===== DGM Deckkraft ===== */
function applyDgmOpacity() {
  const t = parseFloat(dgmRange.value);
  dgmVal.textContent = Math.round(t*100) + '%';
  if (dgmLayer && dgmLayer.setOpacity) dgmLayer.setOpacity(t);
}

/* ===== WMS laden (ohne GetCapabilities) ===== */
(function initWMS(){
  const names = Object.keys(layers); // evtl. 'Bodendenkmale (BRB)'

  for (const svc of WMS) {
    const opts = { layers: svc.layer, format:'image/png', transparent:true, opacity:0, crossOrigin:false };
    if (svc.isDGM) {
      dgmLayer = L.tileLayer.wms(svc.u, Object.assign({}, opts, { pane:'dgmPane', opacity: parseFloat(dgmRange.value) || 0 }));
      dgmLayer.addTo(map);
      names.push(svc.n);
      // Debug: logge Tile-Fehler
      dgmLayer.on('tileerror', (e)=>console.warn('DGM tileerror', svc, e));
    } else {
      const tile = L.tileLayer.wms(svc.u, Object.assign({}, opts, { pane:'overlayA' }));
      tile.addTo(map);                // wird per Opacity gesteuert
      layers[svc.n] = { tile };
      names.push(svc.n);
      tile.on('tileerror', (e)=>console.warn('WMS tileerror', svc, e));
    }
  }

  fillSelects(names);

  // Defaults ‚Äì so sieht man sofort Wirkung
  const defA = "DOP20 2019‚Äì2021 (Farbe)";
  const defB = "DOP20 2016‚Äì2018 (Farbe)";
  if ([...selA.options].some(o => o.value===defA)) selA.value = defA;
  if ([...selB.options].some(o => o.value===defB)) selB.value = defB;

  updateOverlayVisibility();
  applyDgmOpacity();
})();

/* ===== Events ===== */
selA.addEventListener('change', () => { if (selB.value === selA.value) selB.value = '__none__'; updateOverlayVisibility(); });

selB.addEventListener('change', () => {
  // B in eigenes Pane heben (√ºber A)
  for (const n in layers) {
    const Lr = layers[n].tile;
    if (Lr && Lr.options) { Lr.options.pane = 'overlayA'; if (Lr.setZIndex) Lr.setZIndex(350); }
  }
  const b = selB.value;
  if (b && b!=='__none__' && layers[b] && layers[b].tile) {
    layers[b].tile.options.pane = 'overlayB';
    if (layers[b].tile.setZIndex) layers[b].tile.setZIndex(360);
    if (map.hasLayer(layers[b].tile)) { map.removeLayer(layers[b].tile); }
    layers[b].tile.addTo(map);
  }
  updateOverlayVisibility();
});

globalOpacity.addEventListener('input', updateOverlayVisibility);
dgmRange.addEventListener('input', applyDgmOpacity);

/* ===== Mobile UX ===== */
(function tuneMobile(){
  const isNarrow = window.matchMedia('(max-width: 820px)').matches;
  if (isNarrow) {
    [selA, selB, globalOpacity, dgmRange, chkFeat].forEach(el=>{
      el && el.addEventListener('focus', ()=> sheet.classList.add('open'), {once:true});
    });
  } else {
    sheet.classList.add('open');
  }
})();

/* ===== Feature-Toggle ===== */
chkFeat.addEventListener('change', () => {
  if (!featLayer) return;
  if (chkFeat.checked) featLayer.addTo(map); else map.removeLayer(featLayer);
});
</script>
</body>
</html>
